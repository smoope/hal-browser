<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<dom-module id="hal-browser-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>HAL Browser - OAuth2</h2>

    <paper-radio-group selected="{{grant}}">
	<paper-radio-button name="password">password</paper-radio-button>
	<paper-radio-button name="client_credentials">client_credentials</paper-radio-button>
    </paper-radio-group>
    
    <paper-input label="OAuth2 Server" value="{{server}}"></paper-input>
    <paper-input label="Client ID" value="{{clientId}}"></paper-input>
    <paper-input label="Client Secret" value="{{clientSecret}}"></paper-input>
    <paper-input id="username" label="Username" value="{{username}}"></paper-input>
    <paper-input id="password" label="Password" value="{{password}}"></paper-input>
    <paper-button raised on-tap="signin">Sign in</paper-button>
    <paper-toast id="toast" text="hello"></paper-toast>
  </template>

  <script>
   Polymer({

       is: 'hal-browser-app',

       properties: {
	   grant: {
	       type: String,
	       value: 'client_credentials',
	       notify: true,
	       observer: 'grantChanged'
	   },

	   server: String,
	   username: String,
	   password: String,
	   clientId: String,
	   clientSecret: String
       },

       ready: function() {
	   var self = this;
	   var request = new XMLHttpRequest();
	   var wellknown = window.location.protocol + "//" + window.location.hostname + "/.well-known/smoope";
	   request.open('GET', wellknown);
	   
	   request.onerror = function(err) {
	       self.server = 'http://10.35.10.10:8083/token';
	       self.$.toast.text = "Falling back to dev oauth server";
	       self.$.toast.open();
	   }
	   
	   request.onload = function() {
	       if (request.status == 200) {
		   var data = JSON.parse(request.responseText);
		   self.server = data.tokenEndpoint;
	       } else {
		   self.$.toast.text = "Response: " + request.status;
		   self.$.toast.open();
	       }
	   }

	   request.send();
       },

       grantChanged: function(e) {
	   var hide = e === "client_credentials";
	   this.$.username.hidden = hide;
	   this.$.password.hidden = hide;
       },

       signin: function(e) {
	   e.target.disabled = true;

	   var self = this;
	   var request = new XMLHttpRequest();
	   request.open('POST', this.server);
	   request.setRequestHeader('Authorization', 'Basic ' + btoa(this.clientId + ':' + this.clientSecret));
	   request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
	   
	   request.onerror = function(err) {
	       e.target.disabled = false;
	       self.$.toast.text = "Could not connect to server";
	       self.$.toast.open();
	   }
	   
	   request.onload = function() {
	       e.target.disabled = false;

	       if (request.status == 200) {
		   var data = JSON.parse(request.responseText);
		   document.cookie = "MyHalBrowserToken=" + data.access_token;
		   window.location.href = 'browser.html'
	       } else {
		   self.$.toast.text = "Response: " + request.status;
		   self.$.toast.open();
	       }
	   }
	   
	   var data = 'grant_type=' + this.grant;
	   if (this.grant === "password") {
	       data = data + '&password=' + this.password +'&username=' + this.username;
	   }

	   request.send(data);
       },

   });
  </script>
</dom-module>
